<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Streaming Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .output {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            min-height: 100px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>AI Streaming Examples</h1>

    <!-- Gen Pollinations AI Section -->
    <div class="container">
        <h2>Gen Pollinations AI</h2>
        <button onclick="generateImage()">Generate Image</button>
        <div class="output" id="imageOutput">Image generation status will appear here...</div>
    </div>

    <!-- OpenAI Chat Completions Section -->
    <div class="container">
        <h2>OpenAI Chat Completions with Tools</h2>
        <button onclick="chatCompletion()">Start Chat Stream</button>
        <div class="output" id="chatOutput">Chat response will appear here...</div>
    </div>

    <script>
        // Gen Pollinations AI Example
        async function generateImage() {
            const output = document.getElementById('imageOutput');
            output.textContent = 'Starting image generation...\n';
            
            try {
                // Pollinations AI endpoint for image generation
                const response = await fetch('https://image.pollinations.ai/prompt/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: 'A beautiful futuristic city with flying cars and neon lights',
                        width: 512,
                        height: 512,
                        seed: 12345 // Using seed for reproducible results
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                output.textContent += `Image generated successfully!\n`;
                output.textContent += `Image URL: ${response.url}\n`;
                
                // Display the image
                const img = document.createElement('img');
                img.src = response.url;
                img.style.maxWidth = '100%';
                img.style.marginTop = '10px';
                output.appendChild(img);

            } catch (error) {
                output.textContent += `Error: ${error.message}\n`;
            }
        }

        // OpenAI Chat Completions with Streaming and Tools
        async function chatCompletion() {
            const output = document.getElementById('chatOutput');
            output.textContent = 'Starting chat stream...\n';
            
            // Replace with your actual OpenAI API key
            const API_KEY = 'your-openai-api-key-here';
            
            // Example tools definition
            const tools = [
                {
                    type: "function",
                    function: {
                        name: "get_weather",
                        description: "Get the current weather for a location",
                        parameters: {
                            type: "object",
                            properties: {
                                location: {
                                    type: "string",
                                    description: "The city and state, e.g. San Francisco, CA"
                                },
                                unit: {
                                    type: "string",
                                    enum: ["celsius", "fahrenheit"],
                                    description: "The temperature unit"
                                }
                            },
                            required: ["location"]
                        }
                    }
                },
                {
                    type: "function",
                    function: {
                        name: "calculate",
                        description: "Perform mathematical calculations",
                        parameters: {
                            type: "object",
                            properties: {
                                expression: {
                                    type: "string",
                                    description: "The mathematical expression to evaluate"
                                }
                            },
                            required: ["expression"]
                        }
                    }
                }
            ];

            try {
                const response = await fetch('https://g4f.dev/api/nectar/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gemini',
                        messages: [
                            {
                                role: 'user',
                                content: 'What is the weather in New York and also calculate 15 * 8 + 23?'
                            }
                        ],
                        tools: tools,
                        tool_choice: 'auto',
                        stream: true, // Enable streaming
                        seed: 42, // Using seed for reproducible results
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        
                        if (trimmedLine === 'data: [DONE]') {
                            output.textContent += '\nStream completed!\n';
                            return;
                        }
                        
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(trimmedLine.slice(6));
                                
                                if (data.choices && data.choices[0].delta) {
                                    const delta = data.choices[0].delta;
                                    
                                    if (delta.tool_calls) {
                                        output.textContent += `Tool call detected: ${JSON.stringify(delta.tool_calls)}\n`;
                                    } else if (delta.content) {
                                        accumulatedContent += delta.content;
                                        // Update output more efficiently by showing accumulated content
                                        output.textContent = 'Chat Response:\n' + accumulatedContent;
                                    }
                                }
                            } catch (e) {
                                // Skip invalid JSON lines
                            }
                        }
                    }
                }

            } catch (error) {
                output.textContent += `Error: ${error.message}\n`;
            }
        }

        // Alternative function for handling streaming with function calls
        async function chatWithFunctionHandling() {
            const output = document.getElementById('chatOutput');
            output.textContent = 'Starting chat with function handling...\n';
                        
            const tools = [
                {
                    type: "function",
                    function: {
                        name: "get_current_time",
                        description: "Get the current time in a specific timezone",
                        parameters: {
                            type: "object",
                            properties: {
                                timezone: {
                                    type: "string",
                                    description: "The timezone, e.g. America/New_York"
                                }
                            },
                            required: ["timezone"]
                        }
                    }
                }
            ];

            try {
                const response = await fetch('https://g4f.dev/api/nectar/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'openai',
                        messages: [
                            {
                                role: 'user',
                                content: 'What time is it in Tokyo?'
                            }
                        ],
                        tools: tools,
                        stream: true,
                        seed: 123,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        
                        if (trimmedLine === 'data: [DONE]') {
                            output.textContent += '\n--- Stream ended ---\n';
                            return;
                        }
                        
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(trimmedLine.slice(6));
                                
                                if (data.choices && data.choices[0].delta) {
                                    const delta = data.choices[0].delta;
                                    
                                    // Handle function calls
                                    if (delta.tool_calls) {
                                        output.textContent += `Function call streamed: ${JSON.stringify(delta.tool_calls)}\n`;
                                    }
                                    
                                    // Handle content
                                    if (delta.content) {
                                        content += delta.content;
                                        output.textContent = 'Streaming response:\n' + content;
                                    }
                                }
                            } catch (e) {
                                // Ignore parse errors for incomplete chunks
                            }
                        }
                    }
                }

            } catch (error) {
                output.textContent += `Error: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>
